variables:
  GO111MODULE: "on"
  CGO_ENABLED: "0"
  BINARY_NAME: "ult"

stages:
  - build
  - release

build-job:
  image: golang:1.23-alpine3.20
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Downloading go packages"
    - go mod download

    - echo "Compiling ult for linux amd64"
    - mkdir -p linux-amd64
    - GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o linux-amd64/${BINARY_NAME} .
    - tar -czvf linux-amd64.tar.gz linux-amd64

    - echo "Compiling ult for macos amd64"
    - mkdir -p darwin-amd64
    - GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o darwin-amd64/${BINARY_NAME} .
    - tar -czvf darwin-amd64.tar.gz darwin-amd64

    - echo "Compiling ult for macos arm64"
    - mkdir -p darwin-arm64
    - GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o darwin-arm64/${BINARY_NAME} .
    - tar -czvf darwin-arm64.tar.gz darwin-arm64

  artifacts:
    paths:
      - ./linux-amd64.tar.gz
      - ./darwin-amd64.tar.gz
      - ./darwin-arm64.tar.gz
    when: on_success
    access: all
    expire_in: 1 week

release-job:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: release
  needs: ["build-job"]
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - ls
    - echo "Creating checksum files for archives"
    - sha256sum linux-amd64.tar.gz > linux-amd64-checksum.txt
    - sha256sum darwin-amd64.tar.gz > darwin-amd64-checksum.txt
    - sha256sum darwin-arm64.tar.gz > darwin-arm64-checksum.txt
  dependencies:
    - build-job
  artifacts:
    paths:
      - ./checksum.txt
    when: on_success
    access: all
    expire_in: never

  release:
    name: "Release $CI_COMMIT_TAG"
    description: "Automated release for tag $CI_COMMIT_TAG"
    tag_name: $CI_COMMIT_TAG
    assets:
      links:
        - name: "linux amd64 executable"
          url: "${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/linux-amd64.tar.gz"
          link_type: "package"
        - name: "linux amd64 archive checksum"
          url: "${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/linux-amd64-checksum.txt"
          link_type: "other"

        - name: "darwin amd64 executable"
          url: "${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/darwin-amd64.tar.gz"
          link_type: "package"
        - name: "darwin amd64 archive checksum"
          url: "${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/darwin-amd64-checksum.txt"  
          link_type: "other"

        - name: "darwin arm64 executable"
          url: "${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/darwin-arm64.tar.gz"
          link_type: "package"
        - name: "darwin arm64 archive checksum"
          url: "${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/darwin-arm64-checksum.txt"
          link_type: "other"
